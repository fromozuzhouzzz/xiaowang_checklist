<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>開／關店 Checklist</title>
  <link rel="stylesheet" href="style.css" />
  <!-- 使用簡單 CDN 版 FullCalendar -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
  <script type="module" src="tasks.js"></script>
</head>
<body>
  <h1>飯店開／關店 Checklist</h1>
  <div class="buttons">
    <button id="btn-open">開店</button>
    <button id="btn-close">關店</button>
  </div>
  <div id="checklist"></div>
  <div id="submit-area" style="display:none;">
    <input id="input-name" placeholder="提交人姓名" />
    <button id="btn-submit">提交</button>
  </div>
  <h2>日曆紀錄</h2>
  <div id="calendar"></div>

  <script type="module">
    import { OPEN_TASKS, CLOSE_TASKS } from './tasks.js';

    const state = { shift: null, tasks: [] };

    document.getElementById('btn-open').onclick = () => loadShift('open');
    document.getElementById('btn-close').onclick = () => loadShift('close');
    document.getElementById('btn-submit').onclick = submit;

    function loadShift(shift) {
      state.shift = shift;
      state.tasks = shift === 'open' ? OPEN_TASKS : CLOSE_TASKS;
      renderChecklist();
      document.getElementById('submit-area').style.display = 'block';
    }

    function renderChecklist() {
      const box = document.getElementById('checklist');
      box.innerHTML = state.tasks.map(t => `
        <label><input type="checkbox" value="${t.id}" /> ${t.title}</label><br>
      `).join('');
    }

    async function submit() {
      const name = document.getElementById('input-name').value.trim();
      if (!name) return alert('請填姓名');
      const checked = Array.from(document.querySelectorAll('#checklist input:checked')).map(el => Number(el.value));
      if (checked.length !== state.tasks.length) return alert('仍有項目未勾選');

      const payload = {
        date: new Date().toISOString().slice(0,10),
        shift: state.shift,
        completed: checked,
        by: name
      };
      const res = await fetch('/api/submit', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      if (res.ok) {
        alert('已提交');
        loadCalendar();
        document.getElementById('submit-area').style.display='none';
        document.getElementById('checklist').innerHTML='';
      } else alert('提交失敗');
    }

    /* -------- Calendar -------- */
    let calendar;
    async function loadCalendar() {
      const month = new Date().toISOString().slice(0,7);
      const data = await fetch(`/api/summary?month=${month}`).then(r=>r.json());
      const events = Object.entries(data).flatMap(([date,val]) => {
        const ev=[];
        if (val.open) ev.push({ title:'開✅', date });
        else ev.push({ title:'開❌', date, color:'red' });
        if (val.close) ev.push({ title:'關✅', date });
        else ev.push({ title:'關❌', date, color:'red' });
        return ev;
      });
      if (!calendar) {
        calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
          initialView:'dayGridMonth',
          events
        });
        calendar.render();
      } else {
        calendar.removeAllEvents();
        events.forEach(e=>calendar.addEvent(e));
      }
    }

    loadCalendar();
  </script>
</body>
</html> 