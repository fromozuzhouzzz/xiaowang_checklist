<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>开/关店 Checklist</title>
  <link rel="stylesheet" href="style.css" />
  <!-- 使用简单 CDN 版 FullCalendar -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
  <script type="module" src="tasks.js"></script>
</head>
<body>
  <h1>小汪有料开店/关店工作流程</h1>
  <div class="buttons">
    <button id="btn-open">开店</button>
    <button id="btn-close">关店</button>
  </div>
  <div id="checklist"></div>
  <div id="submit-area" style="display:none;">
    <input id="input-name" placeholder="提交人姓名" />
    <button id="btn-submit">提交</button>
  </div>
  <h2>日历记录</h2>
  <div id="calendar"></div>

  <script type="module">
    import { OPEN_TASKS, CLOSE_TASKS } from './tasks.js';

    const state = { shift: null, tasks: [] };

    document.getElementById('btn-open').onclick = () => loadShift('open');
    document.getElementById('btn-close').onclick = () => loadShift('close');
    document.getElementById('btn-submit').onclick = submit;

    function loadShift(shift) {
      state.shift = shift;
      state.tasks = shift === 'open' ? OPEN_TASKS : CLOSE_TASKS;
      renderChecklist();
      document.getElementById('submit-area').style.display = 'block';
    }

    function renderChecklist() {
      const box = document.getElementById('checklist');
      box.innerHTML = state.tasks.map(t => `
        <label><input type="checkbox" value="${t.id}" /> ${t.title}</label><br>
      `).join('');
    }

    async function submit() {
      const name = document.getElementById('input-name').value.trim();
      if (!name) return alert('请填姓名');
      const checked = Array.from(document.querySelectorAll('#checklist input:checked')).map(el => Number(el.value));
      if (checked.length !== state.tasks.length) return alert('仍有项目未勾选');

      const payload = {
        date: new Date().toISOString().slice(0,10),
        shift: state.shift,
        completed: checked,
        by: name
      };
      
      try {
        const res = await fetch('/api/submit', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        if (res.ok) {
          alert('已提交');
          loadCalendar();
          document.getElementById('submit-area').style.display='none';
          document.getElementById('checklist').innerHTML='';
          document.getElementById('input-name').value = '';
        } else {
          const errorText = await res.text();
          alert('提交失败: ' + errorText);
        }
      } catch (error) {
        console.error('提交错误:', error);
        alert('提交失败，请检查网络连接');
      }
    }

    /* -------- Calendar -------- */
    let calendar;
    
    // 格式化时间显示
    function formatTime(isoString) {
      if (!isoString || isoString === '未知时间') return '未知时间';
      try {
        const date = new Date(isoString);
        return date.toLocaleString('zh-CN', {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit'
        });
      } catch (e) {
        return '未知时间';
      }
    }
    
    async function loadCalendar() {
      try {
        const month = new Date().toISOString().slice(0,7);
        console.log('正在加载日历数据，月份:', month);
        
        console.log('发送API请求...');
        const response = await fetch(`/api/summary?month=${month}`);
        console.log('API响应状态:', response.status, response.statusText);
        console.log('API响应头:', Object.fromEntries(response.headers.entries()));
        
        if (!response.ok) {
          console.error('API响应不正常:', response.status);
          const errorText = await response.text();
          console.error('错误内容:', errorText);
          throw new Error(`HTTP ${response.status}: ${response.statusText} - ${errorText}`);
        }
        
        console.log('尝试解析JSON响应...');
        const rawText = await response.text();
        console.log('原始响应文本:', rawText);
        
        let data;
        try {
          data = JSON.parse(rawText);
          console.log('JSON解析成功:', data);
        } catch (parseError) {
          console.error('JSON解析失败:', parseError);
          console.error('原始文本:', rawText);
          throw new Error('响应不是有效的JSON格式');
        }
        
        console.log('获取到的日历数据:', data);
        
        const today = new Date().toISOString().slice(0, 10); // 今天的日期
        
        const events = Object.entries(data).flatMap(([date, val]) => {
          const ev = [];
          const isPastDate = date < today; // 判断是否为过去日期
          
          // 开店记录 - 放在上面
          if (val.open) {
            ev.push({ 
              title: '开✅', 
              date,
              extendedProps: {
                type: 'open',
                completed: true,
                submitter: val.openSubmitter || '未知',
                submitTime: val.openSubmitTime || '未知时间'
              }
            });
          } else if (isPastDate) {
            // 只有过去的日期没有记录才显示红色
            ev.push({ 
              title: '开❌', 
              date, 
              color: 'red',
              textColor: 'white',
              extendedProps: {
                type: 'open',
                completed: false
              }
            });
          }
          
          // 关店记录 - 放在下面
          if (val.close) {
            ev.push({ 
              title: '关✅', 
              date,
              extendedProps: {
                type: 'close',
                completed: true,
                submitter: val.closeSubmitter || '未知',
                submitTime: val.closeSubmitTime || '未知时间'
              }
            });
          } else if (isPastDate) {
            // 只有过去的日期没有记录才显示红色
            ev.push({ 
              title: '关❌', 
              date, 
              color: 'red',
              textColor: 'white',
              extendedProps: {
                type: 'close',
                completed: false
              }
            });
          }
          
          return ev;
        });
        
        console.log('生成的日历事件:', events);
        
        if (!calendar) {
          calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
            initialView:'dayGridMonth',
            events,
            headerToolbar: {
              left: 'prev,next',
              center: 'title',
              right: 'today'
            },
            locale: 'zh-cn',
            eventMouseEnter: function(info) {
              // 只为已完成的记录显示提示
              if (info.event.extendedProps.completed) {
                const tooltip = document.createElement('div');
                tooltip.id = 'event-tooltip';
                tooltip.style.cssText = `
                  position: absolute;
                  background: rgba(0,0,0,0.8);
                  color: white;
                  padding: 8px 12px;
                  border-radius: 4px;
                  font-size: 12px;
                  pointer-events: none;
                  z-index: 9999;
                  max-width: 200px;
                  box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                `;
                
                const type = info.event.extendedProps.type === 'open' ? '开店' : '关店';
                const submitter = info.event.extendedProps.submitter;
                const submitTime = info.event.extendedProps.submitTime;
                
                tooltip.innerHTML = `
                  <div><strong>${type}记录</strong></div>
                  <div>提交人: ${submitter}</div>
                  <div>提交时间: ${formatTime(submitTime)}</div>
                `;
                
                document.body.appendChild(tooltip);
                
                // 跟随鼠标位置
                const updatePosition = (e) => {
                  tooltip.style.left = (e.pageX + 10) + 'px';
                  tooltip.style.top = (e.pageY - 10) + 'px';
                };
                
                info.el.addEventListener('mousemove', updatePosition);
                info.el._updateTooltipPosition = updatePosition;
              }
            },
            eventMouseLeave: function(info) {
              const tooltip = document.getElementById('event-tooltip');
              if (tooltip) {
                tooltip.remove();
              }
              if (info.el._updateTooltipPosition) {
                info.el.removeEventListener('mousemove', info.el._updateTooltipPosition);
              }
            }
          });
          calendar.render();
          console.log('日历已渲染');
        } else {
          calendar.removeAllEvents();
          events.forEach(e=>calendar.addEvent(e));
          console.log('日历事件已更新');
        }
      } catch (error) {
        console.error('加载日历失败:', error);
        console.error('错误堆栈:', error.stack);
        alert('加载日历失败: ' + error.message);
      }
    }

    // 页面加载完成后初始化日历
    document.addEventListener('DOMContentLoaded', () => {
      loadCalendar();
    });
  </script>
</body>
</html> 