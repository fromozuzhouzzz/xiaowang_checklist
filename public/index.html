<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>开/关店 Checklist</title>
  
  <!-- Material Design 3 -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  
  <!-- FullCalendar -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
  
  <link rel="stylesheet" href="style.css" />
  <script type="module" src="tasks.js"></script>
</head>
<body>
  <div class="app-container">
    <!-- App Bar -->
    <header class="app-bar">
      <span class="material-icons">store</span>
      <h1>小汪有料开店/关店工作流程</h1>
    </header>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Action Cards -->
      <div class="action-section">
        <div class="action-card" id="btn-open">
          <span class="material-icons">wb_sunny</span>
          <h3>开店</h3>
          <p>开始一天的工作</p>
        </div>
        <div class="action-card" id="btn-close">
          <span class="material-icons">bedtime</span>
          <h3>关店</h3>
          <p>结束一天的工作</p>
        </div>
      </div>

      <!-- Checklist -->
      <div id="checklist-container" class="surface" style="display:none;">
        <h2>工作清单</h2>
        <div id="checklist"></div>
        <div id="submit-area">
          <div class="input-group">
            <input id="input-name" placeholder="提交人姓名" class="text-field" />
            <button id="btn-submit" class="primary-button">
              <span class="material-icons">check</span>
              提交
            </button>
          </div>
        </div>
      </div>

      <!-- Calendar -->
      <div class="calendar-section surface">
        <h2>
          <span class="material-icons">calendar_month</span>
          日历记录
        </h2>
        <div id="calendar"></div>
      </div>
    </main>
  </div>

  <script type="module">
    import { OPEN_TASKS, CLOSE_TASKS } from './tasks.js';

    const state = { shift: null, tasks: [] };

    document.getElementById('btn-open').onclick = () => loadShift('open');
    document.getElementById('btn-close').onclick = () => loadShift('close');
    document.getElementById('btn-submit').onclick = submit;

    function loadShift(shift) {
      state.shift = shift;
      state.tasks = shift === 'open' ? OPEN_TASKS : CLOSE_TASKS;
      renderChecklist();
      document.getElementById('checklist-container').style.display = 'block';
      document.getElementById('checklist-container').scrollIntoView({ behavior: 'smooth' });
    }

    function renderChecklist() {
      const box = document.getElementById('checklist');
      box.innerHTML = state.tasks.map(t => `
        <label class="checkbox-item">
          <input type="checkbox" value="${t.id}" />
          <span class="checkmark"></span>
          <span class="checkbox-text">${t.title}</span>
        </label>
      `).join('');
    }

    async function submit() {
      const name = document.getElementById('input-name').value.trim();
      if (!name) {
        showSnackbar('请填写提交人姓名', 'warning');
        return;
      }
      const checked = Array.from(document.querySelectorAll('#checklist input:checked')).map(el => Number(el.value));
      if (checked.length !== state.tasks.length) {
        showSnackbar('仍有项目未勾选', 'warning');
        return;
      }

      const payload = {
        date: new Date().toISOString().slice(0,10),
        shift: state.shift,
        completed: checked,
        by: name
      };
      
      try {
        const res = await fetch('/api/submit', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        if (res.ok) {
          showSnackbar('提交成功！', 'success');
          loadCalendar();
          document.getElementById('checklist-container').style.display='none';
          document.getElementById('input-name').value = '';
        } else {
          const errorText = await res.text();
          showSnackbar('提交失败: ' + errorText, 'error');
        }
      } catch (error) {
        console.error('提交错误:', error);
        showSnackbar('网络错误，请重试', 'error');
      }
    }

    function showSnackbar(message, type = 'info') {
      const snackbar = document.createElement('div');
      snackbar.className = `snackbar snackbar-${type}`;
      snackbar.textContent = message;
      document.body.appendChild(snackbar);
      
      setTimeout(() => snackbar.classList.add('show'), 100);
      setTimeout(() => {
        snackbar.classList.remove('show');
        setTimeout(() => snackbar.remove(), 300);
      }, 3000);
    }

    /* -------- Calendar -------- */
    let calendar;
    
    // 格式化时间显示
    function formatTime(isoString) {
      if (!isoString || isoString === '未知时间') return '未知时间';
      try {
        const date = new Date(isoString);
        return date.toLocaleString('zh-CN', {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit'
        });
      } catch (e) {
        return '未知时间';
      }
    }
    
    async function loadCalendar() {
      try {
        const month = new Date().toISOString().slice(0,7);
        console.log('正在加载日历数据，月份:', month);
        
        const response = await fetch(`/api/summary?month=${month}`);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('获取到的日历数据:', data);
        
        const today = new Date().toISOString().slice(0, 10);
        
        const events = Object.entries(data).flatMap(([date, val]) => {
          const ev = [];
          const isPastDate = date < today;
          
          // 开店记录 - order: 1 确保在上面
          if (val.open) {
            const submitter = val.openSubmitter || '未知';
            const submitTime = val.openSubmitTime ? formatTime(val.openSubmitTime) : '未知时间';
            ev.push({ 
              title: `开✅\n${submitter}\n${submitTime}`, 
              date,
              order: 1,
              backgroundColor: '#4CAF50',
              borderColor: '#4CAF50',
              extendedProps: {
                type: 'open',
                completed: true,
                submitter: submitter,
                submitTime: submitTime
              }
            });
          } else if (isPastDate) {
            ev.push({ 
              title: '开❌', 
              date, 
              order: 1,
              backgroundColor: '#f44336',
              borderColor: '#f44336',
              textColor: 'white',
              extendedProps: {
                type: 'open',
                completed: false
              }
            });
          }
          
          // 关店记录 - order: 2 确保在下面
          if (val.close) {
            const submitter = val.closeSubmitter || '未知';
            const submitTime = val.closeSubmitTime ? formatTime(val.closeSubmitTime) : '未知时间';
            ev.push({ 
              title: `关✅\n${submitter}\n${submitTime}`, 
              date,
              order: 2,
              backgroundColor: '#2196F3',
              borderColor: '#2196F3',
              extendedProps: {
                type: 'close',
                completed: true,
                submitter: submitter,
                submitTime: submitTime
              }
            });
          } else if (isPastDate) {
            ev.push({ 
              title: '关❌', 
              date, 
              order: 2,
              backgroundColor: '#f44336',
              borderColor: '#f44336',
              textColor: 'white',
              extendedProps: {
                type: 'close',
                completed: false
              }
            });
          }
          
          return ev;
        });
        
        if (!calendar) {
          calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
            initialView:'dayGridMonth',
            events,
            headerToolbar: {
              left: 'prev,next',
              center: 'title',
              right: 'today'
            },
            locale: 'zh-cn',
            height: 'auto',
            eventOrder: 'order',
            eventDisplay: 'block',
            eventTextColor: 'white',
            eventDidMount: function(info) {
              // 设置事件内容的样式，使多行文本正确显示
              info.el.style.whiteSpace = 'pre-line';
              info.el.style.fontSize = '11px';
              info.el.style.lineHeight = '1.2';
              info.el.style.padding = '2px 4px';
              info.el.style.textAlign = 'center';
            }
          });
          calendar.render();
        } else {
          calendar.removeAllEvents();
          events.forEach(e=>calendar.addEvent(e));
        }
      } catch (error) {
        console.error('加载日历失败:', error);
        showSnackbar('加载日历失败: ' + error.message, 'error');
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      loadCalendar();
    });
  </script>
</body>
</html> 