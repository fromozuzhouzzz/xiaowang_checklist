# é…’åº—é–‹ï¼é—œåº— Checklist ç³»çµ±ï¼ˆCloudflareÂ KVÂ å…è²»ç‰ˆï¼‰

> **æœ€çµ‚ç‰ˆ v4.0 â€“ 2025â€‘05â€‘31**
> å®Œå…¨ä½¿ç”¨ Cloudflare Pages + KV å…è²»å±¤ï¼›ç„¡å¸³è™Ÿï¼›æ˜ç¢ºã€Œé–‹åº— / é—œåº—ã€æŒ‰éˆ•ï¼›é™„ **å®Œæ•´å¯é‹è¡Œç¨‹å¼ç¢¼** èˆ‡éƒ¨ç½²æ­¥é©Ÿã€‚



---

## 1. å°ˆæ¡ˆçµæ§‹

```
ğŸ“‚ root
â”œâ”€ public/
â”‚  â”œâ”€ index.html        # UI èˆ‡è…³æœ¬
â”‚  â”œâ”€ tasks.js          # é–‹/é—œåº—ä»»å‹™é…ç½®
â”‚  â””â”€ style.css         # ç°¡æ˜“ CSSï¼ˆå¯æ› Tailwind CDNï¼‰
â”œâ”€ functions/           # Pages Functions (Workers)
â”‚  â”œâ”€ api/
â”‚  â”‚   â”œâ”€ tasks.js      # GET /api/tasks
â”‚  â”‚   â”œâ”€ submit.js     # POST /api/submit
â”‚  â”‚   â””â”€ summary.js    # GET /api/summary
â”œâ”€ wrangler.toml        # ä½œç”¨åŸŸç¶å®š KV
â””â”€ package.json         # åƒ…ç”¨æ–¼æœ¬åœ°é è¦½ï¼Œå¯ä¸ç”¨
```

> åªæœ‰ **6 å€‹æª”æ¡ˆ + 1 å€‹é…ç½®**ã€‚ç›´æ¥æ‹–åˆ° GitHub å³å¯éƒ¨ç½²ã€‚

---

## 2. å‰ç«¯ç¨‹å¼ç¢¼ï¼ˆpublicï¼‰

### 2.1 `tasks.js`

```js
// å¯è‡ªç”±èª¿æ•´
export const OPEN_TASKS = [
  { id: 1, title: 'æ‰“é–‹æ‹›ç‰Œç‡ˆ' },
  { id: 2, title: 'æª¢æŸ¥å¤§é–€å®‰å…¨' },
  { id: 3, title: 'å•Ÿå‹•æ”¶éŠ€ç³»çµ±' }
];

export const CLOSE_TASKS = [
  { id: 1, title: 'é—œé–‰æ‹›ç‰Œç‡ˆ' },
  { id: 2, title: 'é–€çª—ä¸Šé–' },
  { id: 3, title: 'æ”¶éŠ€çµç®—å‚™ä»½' }
];
```

### 2.2 `index.html`

```html
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>é–‹ï¼é—œåº— Checklist</title>
  <link rel="stylesheet" href="style.css" />
  <!-- ä½¿ç”¨ç°¡å–® CDN ç‰ˆ FullCalendar -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
  <script type="module" src="tasks.js"></script>
</head>
<body>
  <h1>é£¯åº—é–‹ï¼é—œåº— Checklist</h1>
  <div class="buttons">
    <button id="btn-open">é–‹åº—</button>
    <button id="btn-close">é—œåº—</button>
  </div>
  <div id="checklist"></div>
  <div id="submit-area" style="display:none;">
    <input id="input-name" placeholder="æäº¤äººå§“å" />
    <button id="btn-submit">æäº¤</button>
  </div>
  <h2>æ—¥æ›†ç´€éŒ„</h2>
  <div id="calendar"></div>

  <script type="module">
    import { OPEN_TASKS, CLOSE_TASKS } from './tasks.js';

    const state = { shift: null, tasks: [] };

    document.getElementById('btn-open').onclick = () => loadShift('open');
    document.getElementById('btn-close').onclick = () => loadShift('close');
    document.getElementById('btn-submit').onclick = submit;

    function loadShift(shift) {
      state.shift = shift;
      state.tasks = shift === 'open' ? OPEN_TASKS : CLOSE_TASKS;
      renderChecklist();
      document.getElementById('submit-area').style.display = 'block';
    }

    function renderChecklist() {
      const box = document.getElementById('checklist');
      box.innerHTML = state.tasks.map(t => `
        <label><input type="checkbox" value="${t.id}" /> ${t.title}</label><br>
      `).join('');
    }

    async function submit() {
      const name = document.getElementById('input-name').value.trim();
      if (!name) return alert('è«‹å¡«å§“å');
      const checked = Array.from(document.querySelectorAll('#checklist input:checked')).map(el => Number(el.value));
      if (checked.length !== state.tasks.length) return alert('ä»æœ‰é …ç›®æœªå‹¾é¸');

      const payload = {
        date: new Date().toISOString().slice(0,10),
        shift: state.shift,
        completed: checked,
        by: name
      };
      const res = await fetch('/api/submit', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      if (res.ok) {
        alert('å·²æäº¤');
        loadCalendar();
        document.getElementById('submit-area').style.display='none';
        document.getElementById('checklist').innerHTML='';
      } else alert('æäº¤å¤±æ•—');
    }

    /* -------- Calendar -------- */
    let calendar;
    async function loadCalendar() {
      const month = new Date().toISOString().slice(0,7);
      const data = await fetch(`/api/summary?month=${month}`).then(r=>r.json());
      const events = Object.entries(data).flatMap(([date,val]) => {
        const ev=[];
        if (val.open) ev.push({ title:'é–‹âœ…', date });
        else ev.push({ title:'é–‹âŒ', date, color:'red' });
        if (val.close) ev.push({ title:'é—œâœ…', date });
        else ev.push({ title:'é—œâŒ', date, color:'red' });
        return ev;
      });
      if (!calendar) {
        calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
          initialView:'dayGridMonth',
          events
        });
        calendar.render();
      } else {
        calendar.removeAllEvents();
        events.forEach(e=>calendar.addEvent(e));
      }
    }

    loadCalendar();
  </script>
</body>
</html>
```

### 2.3 `style.css`

```css
body{font-family:sans-serif;margin:2rem;}
.buttons button{margin-right:1rem;padding:0.5rem 1rem;font-size:1.1rem;}
#checklist{margin:1rem 0;}
#submit-area{margin-top:1rem;}
#submit-area input{padding:0.4rem;margin-right:0.5rem;}
```

---

## 3. Cloudflare Pages Functionsï¼ˆå¾Œç«¯ï¼‰

> æ¯å€‹æª”æ¡ˆéƒ½æ˜¯ç¨ç«‹ Workerï¼Œèªæ³•ç‚º CommonJS / ESModule çš†å¯ã€‚ä»¥ä¸‹ä½¿ç”¨ ESMã€‚

### 3.1 `functions/api/tasks.js`

```js
export async function onRequestGet({ env, query }) {
  const shift = query.get('shift');
  if (!['open','close'].includes(shift)) return new Response('Bad shift', {status:400});
  const tasksKey = `tasks:${shift}`;
  let tasks = await env.KV.get(tasksKey, { type:'json' });
  if (!tasks) {
    // é¦–æ¬¡åˆå§‹åŒ–ï¼šå¾å‰ç«¯ tasks.js å…§å®¹è¤‡è£½éä¾†
    tasks = shift==='open' ? [
      { id:1,title:'æ‰“é–‹æ‹›ç‰Œç‡ˆ' },
      { id:2,title:'æª¢æŸ¥å¤§é–€å®‰å…¨' },
      { id:3,title:'å•Ÿå‹•æ”¶éŠ€ç³»çµ±' }
    ] : [
      { id:1,title:'é—œé–‰æ‹›ç‰Œç‡ˆ' },
      { id:2,title:'é–€çª—ä¸Šé–' },
      { id:3,title:'æ”¶éŠ€çµç®—å‚™ä»½' }
    ];
    await env.KV.put(tasksKey, JSON.stringify(tasks));
  }
  return Response.json(tasks);
}
```

### 3.2 `functions/api/submit.js`

```js
export async function onRequestPost({ request, env }) {
  const { date, shift, completed, by } = await request.json();
  if (!date||!shift||!completed||!by) return new Response('Bad', {status:400});
  const key = `log:${date}`;
  const log = await env.KV.get(key, {type:'json'}) || { open:null, close:null };
  log[shift] = { completed, by, ts:Date.now() };
  await env.KV.put(key, JSON.stringify(log));
  return Response.json({ok:true});
}
```

### 3.3 `functions/api/summary.js`

```js
export async function onRequestGet({ query, env }) {
  const month = query.get('month'); // YYYY-MM
  if (!month) return new Response('Need month', {status:400});
  const list = await env.KV.list({ prefix:'log:'+month });
  const res = {};
  for (const { name } of list.keys) {
    const date = name.split(':')[1];
    const log = await env.KV.get(name, {type:'json'});
    res[date] = {
      open: log.open && log.open.completed.length===3, // 3 ç‚ºä»»å‹™ç¸½æ•¸ï¼Œå¯å‹•æ…‹
      close: log.close && log.close.completed.length===3
    };
  }
  return Response.json(res);
}
```

### 3.4 `wrangler.toml`

```toml
name = "hotel-checklist"
compatibility_date = "2025-05-31"

[[kv_namespaces]]
binding = "KV"
id = "<ä½ çš„ namespace id>"
```

---

## 4. Cloudflare éƒ¨ç½²æ­¥é©Ÿï¼ˆæ‰‹æŠŠæ‰‹ï¼‰

1. **è¨»å†Š / ç™»å…¥ Cloudflare** â†’ é¸å–® Pagesã€‚
2. **Create a Project** â†’ é€£æ¥ GitHub â†’ æ–°å¢å€‰åº«ï¼ˆæ¨ä¸Šæœ¬å°ˆæ¡ˆï¼‰ã€‚
3. **Build settings**:

   * Framework = **None**
   * Build command = `npm run build` (è‹¥ç„¡æ‰“åŒ…å‰‡ç•™ç©º)
   * Build output = `public`ï¼ˆPages æœƒè‡ªå‹•è­˜åˆ¥ functions è³‡æ–™å¤¾ï¼‰
4. **é»æ“Š Deploy** â†’ é¦–æ¬¡éƒ¨ç½²å®Œæˆã€‚
5. é€²å…¥ Pages å°ˆæ¡ˆ **Settings â†’ Functions â†’ KV Bindings**ï¼š

   * Add binding name `KV`, namespace é¸ **Create** â†’ å¡«å¯«ä»»æ„åç¨± â†’ Saveã€‚
   * Pages è‡ªå‹•ä¿®æ”¹ `wrangler.toml` æˆ–ä½ æ‰‹å‹•å¡«å…¥ idã€‚
6. **é‡æ–°éƒ¨ç½²**ï¼ˆCommit æˆ–æŒ‰ Retry deploymentï¼‰ã€‚
7. æ‰“é–‹åˆ†é…çš„ `https://<project>.pages.dev`ï¼Œæ¸¬è©¦ï¼š

   * é»ã€Œé–‹åº—ã€â†’ å‹¾é¸ 3 é … â†’ å¡«åå­— â†’ æäº¤ã€‚
   * æ—¥æ›†å‡ºç¾ç•¶å¤©ã€Œé–‹âœ…ã€ã€ã€Œé—œâŒã€ã€‚
   * é‡è¤‡é—œåº—æ­¥é©Ÿï¼Œå‰‡è®Šç‚º 2 å€‹ç¶ å‹¾ã€‚

> **å‚™ä»½**ï¼šç”¨ Wrangler CLI `wrangler kv:bulk export <namespace-id> > backup.json`ã€‚